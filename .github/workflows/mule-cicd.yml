name: "MuleSoft CloudHub 2.0 CI/CD - cc-pipeline-v1"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select Deployment Environment"
        required: true
        type: choice
        options: [ "Design", "Sandbox" ]
      java_version:
        description: "Java Version for Build"
        required: true
        type: choice
        options: [ "8", "11", "17" ]
      release_tag:
        description: "Release Tag (e.g., v1.0.0)"
        required: true
        type: string

run-name: "Deploy ${{ inputs.release_tag }} → ${{ inputs.environment }}"

env:
  APP_NAME: cc-pipeline-v1
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

# TEST JOB

jobs:
  test:
    name: "Run MUnit Tests"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: test-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: "Run MUnit Tests (Environment Specific)"
        run: |
          if [ "${{ inputs.environment }}" == "DESIGN" ]; then
            mvn clean test -D"mule.env"="${{ secrets.design_mule_env }}" -D"mule.key"="${{ secrets.design_mule_key }}"
          else
            mvn clean test -D"mule.env"="${{ secrets.sandbox_mule_env }}" -D"mule.key"="${{ secrets.sandbox_mule_key }}"
          fi

      - name: Upload MUnit Test Report
        uses: actions/upload-artifact@v4
        with:
          name: "munit-report-${{ inputs.environment }}"
          path: target/site/munit/coverage

# BUILD JOB

  build:
    name: "Build Mule Application"
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: build-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: "Build with Maven (Environment Specific)"
        run: |
          if [ "${{ inputs.environment }}" == "DESIGN" ]; then
            mvn -B package --file pom.xml -D"mule.env"="${{ secrets.design_mule_env }}" -D"mule.key"="${{ secrets.design_mule_key }}" -DskipTests
          else
            mvn -B package --file pom.xml -D"mule.env"="${{ secrets.sandbox_mule_env }}" -D"mule.key"="${{ secrets.sandbox_mule_key }}" -DskipTests
          fi

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "mule-artifact-${{ inputs.environment }}"
          path: target/*.jar

# PUBLISH JOB

  publish:
    name: "Publish to Anypoint Exchange"
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: publish-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: "mule-artifact-${{ inputs.environment }}"

      - name: Publish Artifact to Exchange
        env:
          CLIENT_ID: ${{ secrets.connected_app_id }}
          CLIENT_SECRET: ${{ secrets.connected_app_secret }}
        run: |
          mvn clean deploy -DskipTests -DclientID=$CLIENT_ID -DclientSecret=$CLIENT_SECRET -s settings.xml

# DEPLOY JOB

  deploy:
    name: "Deploy to CloudHub 2.0"
    runs-on: ubuntu-latest
    needs: publish
    environment:
      name: ${{ inputs.environment }}
      url: https://anypoint.mulesoft.com

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}

      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: deploy-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: "mule-artifact-${{ inputs.environment }}"

      - name: "Deploy to CloudHub 2.0 (Environment Specific)"
        env:
          CLIENT_ID: ${{ secrets.CONNECTED_APP_ID }}
          CLIENT_SECRET: ${{ secrets.CONNECTED_APP_SECRET }}
        run: |
          if [ ${{ inputs.environment }} == "Design" ]; then
            mvn clean deploy -DskipTests -DmuleDeploy -DclientID=$CLIENT_ID -DclientSecret=$CLIENT_SECRET -Denvironment=${{ secrets.DESIGN_MULE_ENV}} -Dmule.key=${{ secrets.DESIGN_MULE_KEY }} -DapplicationName=${APP_NAME}-design -DtargetName=Cloudhub-US-East-2 -Dreplicas=1 -DvCores=0.1 -s settings.xml
          else
            mvn clean deploy -DskipTests -DmuleDeploy -DclientID=$CLIENT_ID -DclientSecret=$CLIENT_SECRET -Denvironment=${{ secrets.SANDBOX_MULE_ENV}} -Dmule.key=${{ secrets.SANDBOX_MULE_KEY }} -DapplicationName=${APP_NAME}-sandbox -DtargetName=Cloudhub-US-East-2 -Dreplicas=1 -DvCores=0.1 -s settings.xml
          fi

# EMAIL NOTIFICATION

  notify:
    name: "Send Deployment Status Email"
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.mail_username }}
          password: ${{ secrets.mail_password }}
          subject: "MuleSoft Deployment ${{ inputs.environment }} - ${{ job.status }}"
          to: "csai22040@glbitm.ac.in"
          from: "Mule CI/CD <${{ secrets.mail_username }}>"
          body: |
            Hello Team,

            MuleSoft Deployment Summary:

            ▪ Application: cc-pipeline-v1
            ▪ Environment: ${{ inputs.environment }}
            ▪ Release: ${{ inputs.release_tag }}
            ▪ Status: ${{ job.status }}
            ▪ Triggered by: ${{ github.actor }}

            View Logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Regards,  
            MuleSoft CI/CD Automation Pipeline
